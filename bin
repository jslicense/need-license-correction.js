#!/usr/bin/env node
var mostDependedUpon = require('./most-depended-upon')
var packageJSON = require('package-json')
var runParallelLimit = require('run-parallel-limit')
var spdxExpressionValidate = require('spdx-expression-validate')

var options = {
  allVersions: true,
  fullMetadata: true
}

var PARALLELISM = 10

runParallelLimit(
  mostDependedUpon.map(function (name) {
    return function (done) {
      packageJSON(name, options)
        .then(function (results) {
          var versions = results.versions
          Object.keys(versions).forEach(function (version) {
            var metadata = versions[version]
            var license = metadata.license
            if (Array.isArray(metadata.licenses)) {
              console.log(name + '@' + version + ': licenses array')
            } else if (!license) {
              console.log(name + '@' + version + ': no license property')
            } else if (typeof license !== 'string') {
              console.log(name + '@' + version + ': license not a string')
            } else if (!spdxExpressionValidate(license)) {
              console.log(name + '@' + version + ': invalid license expression ' + JSON.stringify(license))
            }
            done()
          })
        })
    }
  }),
  PARALLELISM
)
